"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2["default"])(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var _require=require("util"),promisify=_require.promisify,log=require("npmlog"),chalk=require("chalk"),ora=require("ora"),Xray=require("x-ray"),algoliasearch=require("algoliasearch"),axios=require("axios")["default"],_require2=require("ramda"),difference=_require2.difference,_require3=require("./common.js"),MAX_MESSAGE_TEXT_LENGTH=_require3.MAX_MESSAGE_TEXT_LENGTH,createMessageId=_require3.createMessageId,createNpcPageUrl=_require3.createNpcPageUrl,createYearsString=_require3.createYearsString,getCurrentYear=_require3.getCurrentYear,parseMessageId=_require3.parseMessageId,parseMessageUri=_require3.parseMessageUri,partitionByKeyLength=_require3.partitionByKeyLength,bold=chalk.bold,cyan=chalk.cyan,green=chalk.green,scrapeMessageItems=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e,f,g,h;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=new Xray,e=createNpcPageUrl({type:b,year:c}),a.next=4,axios.get(e);case 4:return f=a.sent,g=f.data,a.next=8,promisify(d(g,"a",[{href:"@href"}]));case 8:return h=a.sent,a.abrupt("return",h.map(function(a){var b=a.href;return b}).filter(function(a){return /[.]txt$/.test(a)}).map(parseMessageUri).filter(function(a){var b=a.code,c=a.num;return[b,c].every(function(a){var b=a.length;return 0<b})}));case 10:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),getItem=function(a){var b=a.code,c=a.num,d=a.type,e=a.year,f=a.url,g={code:b,num:c,type:d,url:f,year:e},h=createMessageId(g);return axios.get(f).then(function(a){var b=a.data;return _objectSpread({},g,{id:h,text:b,objectID:h})})["catch"](function(){return _objectSpread({},g,{id:h,objectID:h})})},getItems=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e,f,g,h;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=function(a){var b=(0,_slicedToArray2["default"])(a,1),d=b[0].type,e=createYearsString(c),f="Fetching ".concat(bold(d)," data for ").concat(bold(e)," (").concat(a.length," items)\n\n");return cyan(f)},e=function(a){var b=a.filter(function(a){var b=a.text;return"undefined"!=typeof b});return"".concat(green("COMPLETE")," ~ ").concat(bold(b.length)," of ").concat(bold(a.length)," items processed\n")},f=function(a){return Promise.all(a.map(getItem))},a.next=5,Promise.all(c.map(function(a){return scrapeMessageItems(b,a)}));case 5:return g=a.sent.flat(1/0),h=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(){var b,c,h,i,j,k,l;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return b=ora(d(g)).start(),a.next=3,f(g);case 3:return c=a.sent,h=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(c){var d;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=c.filter(function(a){var b=a.text;return"undefined"==typeof b}),b.text=cyan("Trying to fetch data for ".concat(bold(d.length)," of ").concat(g.length," items")),a.abrupt("return",0===d.length?Promise.resolve([]):f(d));case 3:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),a.next=7,h(c);case 7:return i=a.sent,a.next=10,h(i);case 10:return j=a.sent,a.next=13,h(j);case 13:return k=a.sent,l=[].concat((0,_toConsumableArray2["default"])(c),(0,_toConsumableArray2["default"])(i),(0,_toConsumableArray2["default"])(j),(0,_toConsumableArray2["default"])(k)).filter(function(a){var b=a.text;return"undefined"!=typeof b}),b.succeed(e(l)),a.abrupt("return",l);case 17:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),a.abrupt("return",0<g.length?h():[]);case 8:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),getSavedItems=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){var c,d,e,f,g,h,i,j;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=b.id,d=b.key,e=b.name,f=void 0===e?"message":e,g=algoliasearch(c,d),h=g.initIndex(f),a.next=5,h.setSettings({paginationLimitedTo:1e9});case 5:return a.next=7,h.search("",{hitsPerPage:1e9});case 7:return i=a.sent,j=i.hits,a.abrupt("return",j);case 10:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),saveItems=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e,f,g,h,i,j,k,l,m,n;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=c.id,e=c.key,f=c.name,g=void 0===f?"message":f,h=5,i=ora("Connecting to Algolia").start(),j=algoliasearch(d,e),k=j.initIndex(g),a.prev=5,i.text="Saving ".concat(b.length," items..."),l=function(a){return partitionByKeyLength("text",MAX_MESSAGE_TEXT_LENGTH,a)},m=b.flatMap(l).map(function(a,b){return _objectSpread({},a,{objectID:"".concat(a.objectID,"_").concat((b+"").padStart(h,"0"))})}),a.next=11,k.saveObjects(m);case 11:return n=a.sent,i.succeed("Successfully saved ".concat(b.length," (").concat(m.length," total) items!\n")),a.abrupt("return",n);case 16:a.prev=16,a.t0=a["catch"](5),i.fail("Failed to save ".concat(b.length," items")),log.error(a.t0);case 20:case"end":return a.stop();}},a,null,[[5,16]])}));return function(){return a.apply(this,arguments)}}(),populate=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c,d){var e,f,g,h,i;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return e=d.id,f=d.key,g=d.name,a.next=3,getItems(b,c);case 3:return h=a.sent,a.next=6,saveItems(h,{id:e,key:f,name:g});case 6:return i=a.sent,a.abrupt("return",i);case 8:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),update=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=c.id,e=c.key,f=c.name,g=c.verbose,h=void 0===g||g,a.next=3,Promise.all([getItems(b,[getCurrentYear()],{verbose:h}),getSavedItems({id:d,key:e,name:f})]);case 3:return i=a.sent,j=(0,_slicedToArray2["default"])(i,2),k=j[0],l=j[1],m=k.map(function(a){var b=a.id;return b}),n=(0,_toConsumableArray2["default"])(new Set(l.map(function(a){var b=a.id;return b}))),o=difference(m,n).sort().map(parseMessageId),a.next=12,Promise.all(o.map(getItem));case 12:if(p=a.sent,q=0===p.length,q&&process.stdout.write("".concat(bold("No records to update"),"\n\n")),!q){a.next=19;break}a.t0={objectIDs:[]},a.next=22;break;case 19:return a.next=21,saveItems(p,{id:d,key:e,name:f});case 21:a.t0=a.sent;case 22:return a.abrupt("return",a.t0);case 23:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}();module.exports={getItem:getItem,getItems:getItems,getSavedItems:getSavedItems,populate:populate,saveItems:saveItems,scrapeMessageItems:scrapeMessageItems,update:update};