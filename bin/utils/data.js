"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.flat"),require("core-js/modules/es.array.flat-map"),require("core-js/modules/es.array.iterator"),require("core-js/modules/es.array.sort"),require("core-js/modules/es.array.unscopables.flat"),require("core-js/modules/es.array.unscopables.flat-map"),require("core-js/modules/es.object.get-own-property-descriptors"),require("core-js/modules/es.promise"),require("core-js/modules/es.string.pad-start");var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2.default)(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}const{promisify}=require("util"),log=require("npmlog"),chalk=require("chalk"),ora=require("ora"),Xray=require("x-ray"),algoliasearch=require("algoliasearch"),axios=require("axios").default,{difference}=require("ramda"),{MAX_MESSAGE_TEXT_LENGTH,createMessageId,createNpcPageUrl,createYearsString,getCurrentYear,parseMessageId,parseMessageUri,partitionByKeyLength}=require("./common.js"),{bold,cyan,green}=chalk,scrapeMessageItems=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(function*(a,b){const c=new Xray,d=createNpcPageUrl({type:a,year:b}),{data:e}=yield axios.get(d),f=yield promisify(c(e,"a",[{href:"@href"}]));return f.map(({href:a})=>a).filter(a=>/[.]txt$/.test(a)).map(parseMessageUri).filter(({code:a,num:b})=>[a,b].every(({length:a})=>0<a))});return function(){return a.apply(this,arguments)}}(),getItem=({code:a,num:b,type:c,year:d,url:e})=>{const f={code:a,num:b,type:c,url:e,year:d},g=createMessageId(f);return axios.get(e).then(({data:a})=>_objectSpread({},f,{id:g,text:a,objectID:g})).catch(()=>_objectSpread({},f,{id:g,objectID:g}))},getItems=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(function*(a,b){const c=a=>{const[{type:c}]=a,d=createYearsString(b),e=`Fetching ${bold(c)} data for ${bold(d)} (${a.length} items)\n\n`;return cyan(e)},d=a=>{const b=a.filter(({text:a})=>"undefined"!=typeof a);return`${green("COMPLETE")} ~ ${bold(b.length)} of ${bold(a.length)} items processed\n`},e=a=>Promise.all(a.map(getItem)),f=(yield Promise.all(b.map(b=>scrapeMessageItems(a,b)))).flat(1/0),g=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(function*(){const a=ora(c(f)).start(),b=yield e(f),g=/*#__PURE__*/function(){var b=(0,_asyncToGenerator2.default)(function*(b){const c=b.filter(({text:a})=>"undefined"==typeof a);return a.text=cyan(`Trying to fetch data for ${bold(c.length)} of ${f.length} items`),0===c.length?Promise.resolve([]):e(c)});return function(){return b.apply(this,arguments)}}(),h=yield g(b),i=yield g(h),j=yield g(i),k=[...b,...h,...i,...j].filter(({text:a})=>"undefined"!=typeof a);return a.succeed(d(k)),k});return function(){return a.apply(this,arguments)}}();return 0<f.length?g():[]});return function(){return a.apply(this,arguments)}}(),getSavedItems=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(function*({id:a,key:b,name:c="message"}){const d=algoliasearch(a,b),e=d.initIndex(c);yield e.setSettings({paginationLimitedTo:1e9});const{hits:f}=yield e.search("",{hitsPerPage:1e9});return f});return function(){return a.apply(this,arguments)}}(),saveItems=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(function*(a,{id:b,key:c,name:d="message"}){const e=ora("Connecting to Algolia").start(),f=algoliasearch(b,c),g=f.initIndex(d);try{e.text=`Saving ${a.length} items...`;const b=a.flatMap(a=>partitionByKeyLength("text",MAX_MESSAGE_TEXT_LENGTH,a)).map((a,b)=>_objectSpread({},a,{objectID:`${a.objectID}_${(b+"").padStart(5,"0")}`})),c=yield g.saveObjects(b);return e.succeed(`Successfully saved ${a.length} (${b.length} total) items!\n`),c}catch(b){e.fail(`Failed to save ${a.length} items`),log.error(b)}});return function(){return a.apply(this,arguments)}}(),populate=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(function*(a,b,{id:c,key:d,name:e}){const f=yield getItems(a,b),g=yield saveItems(f,{id:c,key:d,name:e});return g});return function(){return a.apply(this,arguments)}}(),update=/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(function*(a,{id:b,key:c,name:d,verbose:e=!0}){const[f,g]=yield Promise.all([getItems(a,[getCurrentYear()],{verbose:e}),getSavedItems({id:b,key:c,name:d})]),h=f.map(({id:a})=>a),i=[...new Set(g.map(({id:a})=>a))],j=difference(h,i).sort().map(parseMessageId),k=yield Promise.all(j.map(getItem)),l=0===k.length;return l&&process.stdout.write(`${bold("No records to update")}\n\n`),l?{objectIDs:[]}:yield saveItems(k,{id:b,key:c,name:d})});return function(){return a.apply(this,arguments)}}();module.exports={getItem,getItems,getSavedItems,populate,saveItems,scrapeMessageItems,update};